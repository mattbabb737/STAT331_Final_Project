---
title: "STAT331_Final_Project"
author: "Justus Nunez, Daniel Alvarez, Matt Babb, Maya Doitch"
format: html
output:
  html_document:
    toc: true
    toc_float: true
    toc_depth: 3
editor: visual
self-contained: true
code-fold: true
message: false
---

## Load the data

```{r results='hide', message=FALSE, warning=FALSE}

library(tidyverse)
library(broom)

child_mortality_data <- read.csv(here::here("child_mortality_0_5_year_olds_dying_per_1000_born.csv"))

co2_pcap_cons <- read.csv(here::here("co2_pcap_cons.csv"))

```

## About the data

### Child mortality data

The `child_mortality_data`set tracks rates of child deaths under the age of five per 1,000 births from 197 countries accounted for by Gapminder. Observations start from the year 1800 and projected through to 2100 based on the observed trends (data begins at 1950 for 12 countries). Each observation corresponds to a single country, and each variable is one year.

### CO2 emissions per capita data

The `co2_pcap_cons` data set tracks tones of carbon dioxide emissions per capita for 194 countries accounted for by Gapminder. Observations start from the year 1800 and extend to the year 2022 (the most recent year with aggregated data). There are no NA values in this data set. Each observation corresponds to a single country, and each variable is one year.

### Hypothesized relationship

We expect that as the amount of CO2 emissions per capita increases for a country, its child mortality rate will drop. While we are not investigating causality, we anticipate that increased CO2 emissions indicate increasing industrialization and modernization within a country, which tends to predict dropping levels of child mortality (Ranganathan et al., 2015).

## Clean the Data

To make the `child_mortality_data`set usable for analysis, we re-designated all of the year variables into characters to standardize the variable type, and then we pivoted the data into long format so that each observation corresponds to a single country for a single year with its associated \`child_mortality\` rate. We then removed the "X" in front of each year (carried over from the original data source), and we re-designated the year variable as a numeric type. This new data set is called \`child_mort_long\`.

Similarly, to make the `co2_pcap_cons` data set usable for analysis, we followed the same series of steps to convert all of the years into numeric variables, free of "X"s, and created a new longer data set that contains one observation for each country per year, along with its associated \`emissions\` value. This new data set is called \`co2_long\`.

```{r}

co2_long <- co2_pcap_cons %>%
  mutate(across(matches("^X(18|19|20)\\d{2}$"), as.character)) %>% 
  pivot_longer(
    cols = matches("^X(18|19|20)\\d{2}$"), 
    names_to = "year",
    values_to = "emissions"
  )

co2_long <- co2_long %>%
  mutate(year = str_remove(year, "^X")) |>
  mutate(year = as.numeric(year))

```

```{r}

child_mort_long <- child_mortality_data %>%
  mutate(across(matches("^X(18|19|20|21)\\d{2}$"), as.character)) %>% 
  pivot_longer(
    cols = matches("^X(18|19|20|21)\\d{2}$"), 
    names_to = "year",
    values_to = "child_mortality"
  )

child_mort_long <- child_mort_long %>%
  mutate(year = str_remove(year, "^X")) |>
  mutate(year = as.numeric(year))

```

## Join the data

The `child_mort_long` data set and the `co2_long` data set were joined to create a new data set called `final_data`, which will be our primary data set for the rest of the project. Using `inner_join`, we were able to constrain the data just to the years 1800 -- 2022, so that all observations are for years that have actually elapsed. The `final_data`set contains one observation for each country per year, with its corresponding rates of `child_mortality` and `emissions`.

```{r results='hide', message=FALSE, warning=FALSE}

final_data <- child_mort_long %>%
  inner_join(co2_long, by = c("year", "country"))

final_data$child_mortality <- as.numeric(as.character(final_data$child_mortality))
final_data$emissions <- as.numeric(as.character(final_data$emissions))

```

## Mean `emissions` and `child_mortality` by `country`

```{r}

summary_table <- final_data %>%
  group_by(country) %>%
  summarise(
    mean_child_mortality = mean(child_mortality, na.rm = TRUE),
    mean_emissions = mean(emissions, na.rm = TRUE)
  )

summary_table
```

## Linear Regression

```{r}

ggplot(summary_table, aes(x = mean_emissions,
                          y = mean_child_mortality)) +
  geom_point() + 
  theme_bw() +
  labs(x = "Mean Emissions", y = "", 
       title = "Scatter Plot of Mean Child Mortality vs Mean Emissions by Country") +
  geom_smooth(method = "lm", color = "blue") +
  scale_x_log10()

```

## Over time

```{r}

yearly_means <- final_data %>%
  group_by(year) %>%
  summarise(
    mean_child_mortality = mean(child_mortality, na.rm = TRUE),
    mean_emissions = mean(emissions, na.rm = TRUE)
  )

```

```{r}

final_data <- final_data %>%
  mutate(Decade = cut(year, breaks = seq(1953, 2023, 10), 
                      labels = c("1953-1962", "1963-1972",
                                 "1973-1982", "1983-1992",
                                 "1993-2002", "2003-2012",
                                 "2013-2022"),
                      include.lowest = TRUE))


final_data_means <- final_data %>%
  filter(!is.na(Decade)) %>%
  group_by(country, Decade) %>%
  summarize(
    mean_emissions = mean(emissions, na.rm = TRUE),
    mean_child_mortality = mean(child_mortality, na.rm = TRUE),
    .groups = 'drop'
  )


ggplot(final_data_means, aes(x = mean_emissions,
                             y = mean_child_mortality)) +
  geom_point() +
  facet_wrap(Decade ~ ., scales = "free") + 
  labs(title = "Mean Child Mortality vs. Mean Emissions Over Decades",
       x = "Mean Emissions",
       y = "Mean Child Mortality") +
  scale_x_log10() +
  theme_bw()

```

## Linear Model

Our explanatory variable is `mean_emissions`, and our response variable is `mean_child_mortality`.

```{r}

final_data_lm <- lm(mean_child_mortality ~ mean_emissions,
                    data = yearly_means)

tidy(final_data_lm)

```

## Fit?

```{r}

final_data_lm |> 
  augment() |> 
ggplot(aes(x = .fitted, y = .resid)) +
  geom_point()

```

The Adjusted R-squared was 0.9476 for the data indicating that close to 95% of the variability in mean child mortality can be explained by mean CO2 emissions. This indicates that the model is a very good fit for the data. The only issue is the plot of the residuals, since the residuals do not have a random distribution and seem to follow a pattern. This could indicate that the relationship between CO2 emissions and child mortality is non-linear and could lead to issues with other tests on the data.

```{r}

final_data_lm %>%
  augment() %>%
  summarise(
    response_variance = var(mean_child_mortality, na.rm = TRUE),
    fitted_variance = var(.fitted, na.rm = TRUE),
    residuals_variance = var(.resid, na.rm = TRUE)
  ) %>%
  pivot_longer(
    everything(),
    names_to = "Metric",
    values_to = "Variance"
  ) %>%
  mutate(
    Metric = case_when(
      Metric == "response_variance" ~ "Variance of Response",
      Metric == "fitted_variance" ~ "Variance of Fitted Values",
      Metric == "residuals_variance" ~ "Variance of Residuals",
      TRUE ~ Metric # Fallback, should not be needed
    )
  )

```

```{r}

predictions <- predict(final_data_lm)
st_error <- sigma(final_data_lm)

predictions %>%
  data.frame(predicted = .) %>%
  mutate(residuals = rnorm(n(), mean = 0, sd = st_error)) %>%
  ggplot(aes(x = predicted, y = residuals)) +
    geom_point()
```

## Simulation Function

```{r results='hide', message=FALSE, warning=FALSE}
noise <- function(x, mean = 0, sd) {
  return(x + rnorm(length(x),
            mean,
            sd)
         )
}

simulations <- map_dfc(.x = 1:1000,
                       .f = ~tibble(simulation = noise(predictions,
                                                       sd = st_error)
                                    )
                       )
```

```{r results='hide', message=FALSE, warning=FALSE}

colnames(simulations) <- colnames(simulations) |> 
  str_replace(pattern = "\\.\\.\\.",
                  replace = "_")

binded_simulations <- yearly_means |>
  filter(!is.na(mean_child_mortality),
         !is.na(mean_emissions)
         ) |>
  select(mean_child_mortality) |>
  bind_cols(simulations)

head(binded_simulations)

```

```{r warning=FALSE}

simulated_r_sq <- binded_simulations |>
  map(~ lm(mean_child_mortality ~ .x, data = binded_simulations)
      ) |>
  map(glance) |>
  map_dbl(~ .x$r.squared)

head(simulated_r_sq)

tibble(simulations = simulated_r_sq) |> 
  ggplot(aes(x = simulations)) + 
  geom_histogram(binwidth = 0.001, color = "black", fill = "skyblue") +
  labs(x = expression("Simulated"~ R^2),
       y = "",
       subtitle = "Number of Simulated Models") +
  theme_bw() +
  scale_y_continuous(breaks = seq(0,
                                  60,
                                  by = 2)
                     )
```

## References

Ranganathan et al., 2015 https://www.nature.com/articles/palcomms201533
